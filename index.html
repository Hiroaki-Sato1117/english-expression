<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Vocab Master</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
:root,[data-theme="light"]{
--bg:#f0f4ff;--bg2:#e0e8f8;--surface:rgba(255,255,255,.85);--surfaceSolid:#fff;
--border:rgba(37,99,235,.08);--border2:rgba(37,99,235,.15);
--text:#0f172a;--text2:#334155;--text3:#64748b;--text4:#94a3b8;
--accent:#2563eb;--accent2:#1d4ed8;--accentLight:rgba(37,99,235,.08);--accentLight2:rgba(37,99,235,.04);
--gold:#f59e0b;--goldBg:rgba(245,158,11,.1);
--red:#ef4444;--redBg:rgba(239,68,68,.08);--orange:#f97316;--orangeBg:rgba(249,115,22,.08);
--green:#22c55e;--greenBg:rgba(34,197,94,.08);
--navBg:rgba(30,64,175,.95);
--shadow:0 2px 12px rgba(0,20,80,.06);--shadow2:0 8px 32px rgba(0,20,80,.08);
--cardHover:rgba(37,99,235,.03);
}
[data-theme="dark"]{
--bg:#0b1121;--bg2:#111827;--surface:rgba(20,30,55,.8);--surfaceSolid:#151e30;
--border:rgba(96,165,250,.1);--border2:rgba(96,165,250,.15);
--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;--text4:#475569;
--accent:#60a5fa;--accent2:#93bbfd;--accentLight:rgba(96,165,250,.1);--accentLight2:rgba(96,165,250,.05);
--gold:#fbbf24;--goldBg:rgba(251,191,36,.1);
--red:#f87171;--redBg:rgba(248,113,113,.08);--orange:#fb923c;--orangeBg:rgba(251,146,60,.08);
--green:#4ade80;--greenBg:rgba(74,222,128,.08);
--navBg:rgba(10,20,50,.95);
--shadow:0 2px 12px rgba(0,0,0,.3);--shadow2:0 8px 32px rgba(0,0,0,.4);
--cardHover:rgba(96,165,250,.05);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
.nav{backdrop-filter:blur(20px);background:var(--navBg);padding:0 20px;display:flex;align-items:center;height:52px;position:sticky;top:0;z-index:50;border-bottom:1px solid rgba(255,255,255,.06);}
.nav-brand{font-weight:800;font-size:15px;color:white;margin-right:24px;white-space:nowrap;}
.nav-tabs{display:flex;gap:2px;height:100%;align-items:end;flex:1;}
.ntab{padding:8px 16px;font-size:12px;font-weight:600;color:rgba(255,255,255,.5);cursor:pointer;border-radius:10px 10px 0 0;transition:all .2s;border:none;background:none;font-family:inherit;white-space:nowrap;}
.ntab:hover{color:rgba(255,255,255,.85);background:rgba(255,255,255,.07);}
.ntab.active{color:var(--text);background:var(--bg);font-weight:700;}
.nav-right{display:flex;align-items:center;margin-left:12px;}
.tbtn{width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.tbtn:hover{background:rgba(255,255,255,.15);}
.main{padding:20px;max-width:1100px;margin:0 auto;}
.tc{display:none;animation:fu .3s ease;}.tc.active{display:block;}
@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

.stat-bar{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap;}
.stat-box{flex:1;min-width:90px;padding:12px 14px;background:var(--surface);border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);text-align:center;}
.sv{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:800;color:var(--accent);}
.sv.gold{color:var(--gold);}
.sl{font-size:9px;color:var(--text3);margin-top:2px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;}

.card{background:var(--surface);backdrop-filter:blur(16px);border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);padding:18px;margin-bottom:14px;transition:all .2s;}
.card:hover{box-shadow:var(--shadow2);}
.c-expr{font-size:18px;font-weight:700;color:var(--accent);margin-bottom:4px;}
.c-mean{font-size:13px;color:var(--text2);margin-bottom:10px;}
.c-meta{font-size:11px;color:var(--text3);display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;}
.badge.due{background:var(--redBg);color:var(--red);}
.badge.active{background:var(--accentLight);color:var(--accent);}
.badge.mastered{background:var(--goldBg);color:var(--gold);}
.badge.overdue{background:var(--orangeBg);color:var(--orange);}
.badge.noex{background:rgba(245,158,11,.1);color:#d97706;}

.prog{display:flex;gap:4px;align-items:center;}
.prog .dot{width:10px;height:10px;border-radius:50%;background:var(--bg2);}.prog .dot.f{background:var(--accent);}.prog .dot.g{background:var(--gold);}
.prog-l{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--text3);margin-left:6px;}

.past-ex{margin:10px 0;padding:8px 12px;background:var(--accentLight2);border-radius:8px;border-left:3px solid var(--accent);}
.pe-title{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.pe-item{font-size:12px;color:var(--text2);padding:3px 0;display:flex;gap:8px;}
.pe-item .en{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text4);min-width:16px;}
.pe-item .ed{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text4);margin-left:auto;flex-shrink:0;}

.ir{display:flex;gap:8px;margin-top:10px;align-items:center;}
.ir input,.ir textarea{flex:1;padding:8px 12px;border:1px solid var(--border2);border-radius:8px;font-family:'Outfit',sans-serif;font-size:13px;background:var(--surfaceSolid);color:var(--text);outline:none;transition:border-color .2s;resize:none;}
.ir input:focus,.ir textarea:focus{border-color:var(--accent);}
.btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;}
.btn-p{background:var(--accent);color:white;}.btn-p:hover{background:var(--accent2);}
.btn-s{background:var(--accentLight);color:var(--accent);border:1px solid var(--border2);}.btn-s:hover{background:var(--accent);color:white;}
.btn-g{background:var(--gold);color:white;}
.btn-d{background:transparent;color:var(--red);border:1px solid var(--redBg);}.btn-d:hover{background:var(--redBg);}
.btn-sm{padding:5px 10px;font-size:11px;}
.btn:disabled{opacity:.5;cursor:not-allowed;}

.empty{text-align:center;padding:40px 20px;color:var(--text4);}
.empty-icon{font-size:48px;margin-bottom:12px;}
.empty-text{font-size:14px;font-weight:500;margin-bottom:16px;}

/* All layout */
.al{display:flex;gap:18px;min-height:70vh;}
.al-l{flex:1;min-width:0;}
.al-r{width:380px;flex-shrink:0;position:sticky;top:72px;align-self:flex-start;max-height:calc(100vh - 92px);overflow-y:auto;}
@media(max-width:850px){.al{flex-direction:column;}.al-r{width:100%;position:static;max-height:none;}}
.al-r::-webkit-scrollbar{width:4px;}.al-r::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px;}

.fb{display:flex;gap:8px;margin-bottom:14px;align-items:center;flex-wrap:wrap;}
.fb select,.fb input{padding:6px 10px;border:1px solid var(--border2);border-radius:7px;font-family:'Outfit',sans-serif;font-size:12px;background:var(--surfaceSolid);color:var(--text);outline:none;}
.fb input{flex:1;min-width:100px;}

.li{padding:12px 14px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all .15s;background:var(--surfaceSolid);}
.li:hover{border-color:var(--accent);background:var(--accentLight2);}
.li.sel{border-color:var(--accent);background:var(--accentLight);box-shadow:0 0 0 2px rgba(37,99,235,.15);}
.li.mst{border-color:var(--gold);background:var(--goldBg);}
.li-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.li-expr{font-size:14px;font-weight:600;}.li-mean{font-size:11px;color:var(--text3);}
.li-bot{display:flex;justify-content:space-between;align-items:center;margin-top:6px;}
.li-next{font-size:10px;color:var(--text4);font-family:'JetBrains Mono',monospace;}

/* Detail & Example Maker */
.dp{background:var(--surface);border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);padding:18px;margin-bottom:14px;}
.dp-e{font-size:20px;font-weight:800;color:var(--accent);margin-bottom:4px;}
.dp-m{font-size:14px;color:var(--text2);margin-bottom:14px;}
.dp-s{margin-bottom:14px;}.dp-st{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}

.tl{display:flex;flex-direction:column;gap:0;}
.tl-i{display:flex;align-items:center;gap:10px;padding:6px 0;position:relative;}
.tl-i:not(:last-child)::after{content:'';position:absolute;left:9px;top:26px;bottom:-6px;width:2px;background:var(--border2);}
.tl-d{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;z-index:1;}
.tl-d.done{background:var(--accent);color:white;}.tl-d.pend{background:var(--bg2);color:var(--text4);}
.tl-d.tod{background:var(--red);color:white;}.tl-d.gld{background:var(--gold);color:white;}
.tl-info{flex:1;font-size:12px;color:var(--text2);}
.tl-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text4);}

/* Example Maker */
.em{background:var(--surface);border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);padding:18px;}
.em h4{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.em-saved{display:flex;align-items:start;gap:6px;padding:6px 10px;background:var(--accentLight2);border-radius:7px;border-left:3px solid var(--accent);margin-bottom:6px;}
.em-saved .et{flex:1;font-size:12px;color:var(--text2);line-height:1.4;}
.em-saved .emeta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text4);flex-shrink:0;}
.em-num{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text4);font-weight:600;min-width:18px;padding-top:2px;}
.em-suggestions{margin:10px 0;}
.em-sug-item{padding:8px 10px;border:1px solid var(--border);border-radius:7px;margin-bottom:5px;font-size:12px;color:var(--text2);cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:8px;}
.em-sug-item:hover{background:var(--accentLight2);border-color:var(--accent);}
.em-sug-item .copy-icon{font-size:14px;flex-shrink:0;opacity:.4;transition:opacity .12s;}
.em-sug-item:hover .copy-icon{opacity:1;}
.em-input-area{margin-top:10px;}
.em-input-area textarea{width:100%;padding:8px 12px;border:1px solid var(--border2);border-radius:8px;font-family:'Outfit',sans-serif;font-size:13px;background:var(--surfaceSolid);color:var(--text);outline:none;resize:none;min-height:44px;transition:border-color .2s;}
.em-input-area textarea:focus{border-color:var(--accent);}
.em-actions{display:flex;gap:8px;margin-top:8px;justify-content:flex-end;align-items:center;}
.em-note{font-size:10px;color:var(--text4);flex:1;}

.loading{display:flex;align-items:center;justify-content:center;padding:20px;color:var(--text3);font-size:13px;gap:8px;}
.spinner{width:18px;height:18px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.added-badge{font-size:10px;color:var(--green);font-weight:600;}

/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;display:none;align-items:center;justify-content:center;}.mo.show{display:flex;}
.modal{background:var(--surfaceSolid);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);padding:24px;width:90%;max-width:440px;}
.modal h3{font-size:16px;font-weight:700;margin-bottom:16px;}
.mf{margin-bottom:12px;}.mf label{display:block;font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px;}
.mf input,.mf textarea{width:100%;padding:8px 12px;border:1px solid var(--border2);border-radius:8px;font-family:'Outfit',sans-serif;font-size:13px;background:var(--surfaceSolid);color:var(--text);outline:none;resize:vertical;}
.mf textarea{min-height:60px;}
.ma{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}

/* Discover */
.dg{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
@media(max-width:700px){.dg{grid-template-columns:1fr;}}
.dc{background:var(--surface);border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;}
.dc-h{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.dc-t{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.dc-list{padding:8px;max-height:400px;overflow-y:auto;}
.di{padding:10px 12px;border-radius:8px;cursor:pointer;transition:all .12s;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;}
.di:hover{background:var(--accentLight2);}.di.sel{background:var(--accentLight);}
.di-l{flex:1;min-width:0;}.di-e{font-size:13px;font-weight:600;}.di-m{font-size:11px;color:var(--text3);margin-top:2px;}
.dd{background:var(--surface);border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);padding:20px;margin-top:18px;}
.dd h4{font-size:18px;font-weight:700;color:var(--accent);margin-bottom:8px;}
.dd-m{font-size:14px;color:var(--text);margin-bottom:12px;line-height:1.5;}
.dd-s{margin-bottom:12px;}.dd-s h5{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.dd-ex{font-size:13px;color:var(--text2);padding:4px 0 4px 12px;border-left:2px solid var(--accent);margin-bottom:6px;}
</style>
</head>
<body>
<nav class="nav"><div class="nav-brand">‚ú¶ Vocab Master</div><div class="nav-tabs" id="nv"></div><div class="nav-right"><button class="tbtn" id="tb" onclick="tTh()">üåô</button></div></nav>
<div class="main"><div class="tc" id="tAll"></div><div class="tc" id="tToday"></div><div class="tc" id="tDiscover"></div></div>
<div class="mo" id="addMo"><div class="modal"><h3>Add New Expression</h3><div class="mf"><label>English Expression</label><input id="mE" placeholder='"break the ice"'></div><div class="mf"><label>Meaning (Japanese)</label><input id="mM" placeholder="Â†¥„ÇíÂíå„Åæ„Åõ„Çã"></div><div class="ma"><button class="btn btn-s" onclick="cMo()">Cancel</button><button class="btn btn-p" onclick="addE()">Add</button></div></div></div>

<script>
const GKEY="AIzaSyCu4QFN38527tXzi9gMVCBBcwnCeWQLpA0";
const INTV=[1,3,7,14,30];
const TABS=[{id:'all',label:'üìö All',r:rAll},{id:'today',label:'üìã Today',r:rToday},{id:'discover',label:'üîç Discover',r:rDisc}];
let D={expressions:[],discCache:{friends:{list:[],details:{}},suits:{list:[],details:{}}},excl:{friends:[],suits:[]}};
let ct='all',selId=null,selDi=null,sugCache={};

const td=()=>new Date().toISOString().split('T')[0];
const fmt=d=>d?((p=d.split('-'))&&`${+p[1]}/${+p[2]}`):'‚Äî';
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function cNext(fromDate,rc){if(rc>=5)return null;const d=new Date(fromDate);d.setDate(d.getDate()+INTV[rc]);return d.toISOString().split('T')[0];}
function isNoEx(e){return!e.mastered&&e.reviewCount===0&&allEx(e).length===0&&(!e.activated);}
function isDue(e){return!e.mastered&&!isNoEx(e)&&e.nextReviewDate&&e.nextReviewDate<=td();}
function isOD(e){return!e.mastered&&!isNoEx(e)&&e.nextReviewDate&&e.nextReviewDate<td();}
function daysLeft(e){if(!e.nextReviewDate||e.mastered)return null;const diff=Math.round((new Date(e.nextReviewDate)-new Date(td()))/864e5);return diff;}
function save(){try{localStorage.setItem('ev2',JSON.stringify(D));}catch(e){}}
function load(){try{const s=localStorage.getItem('ev2');if(s){D=JSON.parse(s);if(!D.expressions)D.expressions=[];if(!D.discCache)D.discCache={friends:{list:[],details:{}},suits:{list:[],details:{}}};if(!D.excl)D.excl={friends:[],suits:[]};}}catch(e){}}
function rProg(e){let h='<div class="prog">';for(let i=0;i<5;i++){const c=i<e.reviewCount?(e.mastered?'dot g':'dot f'):'dot';h+=`<div class="${c}"></div>`;}h+=`<span class="prog-l">${e.reviewCount}/5</span></div>`;return h;}
function allEx(e){const re=(e.reviews||[]).filter(r=>r.example).map(r=>({text:r.example,date:r.date}));const se=(e.examples||[]).map(x=>({text:x.text,date:x.date}));return[...re,...se];}

// NAV
function rNav(){const n=document.getElementById('nv');n.innerHTML='';TABS.forEach(t=>{const b=document.createElement('button');b.className='ntab'+(ct===t.id?' active':'');b.textContent=t.label;b.onclick=()=>{ct=t.id;rNav();rT();};n.appendChild(b);});}
function rT(){document.querySelectorAll('.tc').forEach(e=>e.classList.remove('active'));document.getElementById('t'+ct.charAt(0).toUpperCase()+ct.slice(1)).classList.add('active');TABS.find(t=>t.id===ct).r();}

// TODAY
function rToday(){
  const el=document.getElementById('tToday');
  const dues=D.expressions.filter(isDue).sort((a,b)=>(a.nextReviewDate||'').localeCompare(b.nextReviewDate||''));
  const mw=D.expressions.filter(e=>e.mastered&&e.reviews.length&&(new Date(td())-new Date(e.reviews[e.reviews.length-1].date))/864e5<=7).length;
  const active=D.expressions.filter(e=>!e.mastered).length;
  let h=`<div class="stat-bar"><div class="stat-box"><div class="sv">${dues.length}</div><div class="sl">Due Today</div></div><div class="stat-box"><div class="sv">${active}</div><div class="sl">Active</div></div><div class="stat-box"><div class="sv gold">${mw}</div><div class="sl">Mastered (7d)</div></div></div>`;
  if(!dues.length){
    h+=D.expressions.length?`<div class="empty"><div class="empty-icon">üéâ</div><div class="empty-text">All done for today!</div></div>`:`<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-text">No expressions yet</div><button class="btn btn-p" onclick="ct='all';rNav();rT();">Go to All ‚Üí</button></div>`;
  } else {
    dues.forEach(e=>{
      const od=isOD(e);const exs=allEx(e);
      h+=`<div class="card"><div class="c-expr">"${esc(e.expression)}"</div><div class="c-mean">${esc(e.meaning)}</div><div class="c-meta"><span class="badge ${od?'overdue':'due'}">${od?'Overdue':'Due Today'}</span><span>Review #${e.reviewCount+1} of 5</span></div>`;
      h+=rProg(e);
      if(exs.length){h+=`<div class="past-ex"><div class="pe-title">Past Examples</div>`;exs.forEach((r,i)=>{h+=`<div class="pe-item"><span class="en">${i+1}.</span>${esc(r.text)}<span class="ed">${fmt(r.date)}</span></div>`;});h+=`</div>`;}
      h+=`<div style="margin:10px 0"><div class="dp-st">AI Suggestions</div><div id="tsug_${e.id}"></div><button class="btn btn-s btn-sm" onclick="genSugT('${e.id}')" id="tsugBtn_${e.id}">Generate Examples ‚ñ∂</button></div>`;
      h+=`<div class="ir"><textarea id="trev_${e.id}" placeholder="Write or paste an example sentence to complete review..." rows="1"></textarea><button class="btn btn-p" onclick="doRev('${e.id}','trev_${e.id}')">Save & Review ‚úì</button></div></div>`;
    });
  }
  el.innerHTML=h;
}

function doRev(id,inputId){
  const e=D.expressions.find(x=>x.id===id);if(!e)return;
  const inp=document.getElementById(inputId);
  const ex=inp?inp.value.trim():'';
  if(!ex){alert('Please write an example sentence to complete the review.');return;}
  e.reviews.push({date:td(),example:ex});
  e.reviewCount++;
  if(e.reviewCount>=5){e.mastered=true;e.nextReviewDate=null;}
  else{e.nextReviewDate=cNext(td(),e.reviewCount);}
  save();
  if(ct==='today')rToday();
  if(ct==='all'){rAllList();rAllDet();}
}

// ALL
function rAll(){
  const el=document.getElementById('tAll');
  let h=`<div class="fb"><select id="ff" onchange="rAllList()"><option value="all">All</option><option value="active">Active</option><option value="noex">‚ö†Ô∏è No Example</option><option value="due">Due Today</option><option value="mastered">Mastered</option></select><input id="fs" placeholder="Search..." oninput="rAllList()"><button class="btn btn-p btn-sm" onclick="oMo()">+ Add New</button></div>`;
  h+=`<div class="al"><div class="al-l" id="aL"></div><div class="al-r" id="aR"></div></div>`;
  el.innerHTML=h;rAllList();rAllDet();
}
function rAllList(){
  const el=document.getElementById('aL');if(!el)return;
  const f=document.getElementById('ff')?.value||'all';
  const s=(document.getElementById('fs')?.value||'').toLowerCase();
  let items=D.expressions.filter(e=>{
    if(f==='active'&&e.mastered)return false;if(f==='due'&&!isDue(e))return false;if(f==='mastered'&&!e.mastered)return false;if(f==='noex'&&!isNoEx(e))return false;
    if(s&&!e.expression.toLowerCase().includes(s)&&!e.meaning.toLowerCase().includes(s))return false;return true;
  }).sort((a,b)=>{if(a.mastered!==b.mastered)return a.mastered?1:-1;const aN=isNoEx(a),bN=isNoEx(b);if(aN!==bN)return aN?-1:1;const ad=isDue(a),bd=isDue(b);if(ad!==bd)return ad?-1:1;return(a.nextReviewDate||'9').localeCompare(b.nextReviewDate||'9');});
  if(!items.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üìù</div><div class="empty-text">No expressions found</div><button class="btn btn-p" onclick="oMo()">+ Add</button></div>`;return;}
  let h='';items.forEach(e=>{
    const due=isDue(e),od=isOD(e),noEx=isNoEx(e),dl=daysLeft(e);
    h+=`<div class="li${selId===e.id?' sel':''}${e.mastered?' mst':''}" onclick="selId='${e.id}';rAllList();rAllDet();">`;
    h+=`<div class="li-top"><span class="li-expr">"${esc(e.expression)}"</span>${rProg(e)}</div><div class="li-mean">${esc(e.meaning)}</div>`;
    let status='';
    if(e.mastered)status='üèÜ Mastered';
    else if(noEx)status='‚ö†Ô∏è No example yet';
    else if(od)status='‚ö†Ô∏è Overdue';
    else if(due)status='üî¥ Due today';
    else if(dl!==null&&dl>0)status=`${dl}d until review`;
    else if(dl===0)status='üî¥ Due today';
    else status='Next: '+fmt(e.nextReviewDate);
    h+=`<div class="li-bot"><span class="li-next">${status}</span></div></div>`;
  });el.innerHTML=h;
}

function rAllDet(){
  const el=document.getElementById('aR');if(!el)return;
  const e=D.expressions.find(x=>x.id===selId);
  if(!e){el.innerHTML=`<div class="dp"><div class="empty" style="padding:20px"><div class="empty-icon">üëà</div><div class="empty-text">Select an expression</div></div></div><div class="em"><h4>‚úèÔ∏è Example Maker</h4><div class="empty" style="padding:14px"><div class="empty-text" style="font-size:12px">Select an expression first</div></div></div>`;return;}
  const due=isDue(e);const noEx=isNoEx(e);
  let h=`<div class="dp"><div class="dp-e">"${esc(e.expression)}"</div><div class="dp-m">${esc(e.meaning)}</div>${rProg(e)}`;
  // Status alert
  if(noEx){h+=`<div style="margin:12px 0;padding:10px 14px;background:rgba(245,158,11,.1);border-radius:10px;border:1px solid #d97706"><div style="font-size:12px;font-weight:600;color:#d97706;margin-bottom:2px">‚ö†Ô∏è No example yet</div><div style="font-size:11px;color:var(--text3)">Write your first example below to start the review cycle</div></div>`;}
  else if(due){h+=`<div style="margin:12px 0;padding:10px 14px;background:var(--redBg);border-radius:10px;border:1px solid var(--red)"><div style="font-size:12px;font-weight:600;color:var(--red)">‚è∞ Due for review ‚Äî write an example below to complete</div></div>`;}
  // Timeline
  h+=`<div class="dp-s"><div class="dp-st">Review Timeline</div><div class="tl">`;
  h+=`<div class="tl-i"><div class="tl-d done">üìñ</div><div class="tl-info">Learned</div><div class="tl-date">${fmt(e.learnedDate)}</div></div>`;
  for(let i=0;i<5;i++){const rv=e.reviews[i];const dn=!!rv;const isT=!dn&&e.reviewCount===i&&e.nextReviewDate===td();const dc=dn?(i===4?'tl-d gld':'tl-d done'):isT?'tl-d tod':'tl-d pend';
    h+=`<div class="tl-i"><div class="${dc}">${dn?'‚úì':(i+1)}</div><div class="tl-info">Review ${i+1} (${INTV[i]}d)</div><div class="tl-date">${dn?fmt(rv.date):(e.reviewCount===i&&e.nextReviewDate?fmt(e.nextReviewDate):'‚Äî')}</div></div>`;}
  h+=`</div></div>`;
  h+=`<div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px"><span class="badge active">${e.source||'manual'}</span><button class="btn btn-d btn-sm" onclick="delE('${e.id}')">Delete</button></div></div>`;

  // Example Maker
  h+=`<div class="em"><h4>‚úèÔ∏è Example Maker</h4>`;
  const exs=allEx(e);
  if(exs.length){h+=`<div class="dp-st">Saved Examples</div>`;exs.forEach((r,i)=>{h+=`<div class="em-saved"><span class="em-num">${i+1}.</span><span class="et">${esc(r.text)}</span><span class="emeta">${fmt(r.date)}</span></div>`;});}

  h+=`<div class="dp-st" style="margin-top:12px">AI Suggestions</div>`;
  h+=`<div id="sugArea_${e.id}">`;
  const cached=sugCache[e.id];
  if(cached){cached.forEach(s=>{h+=`<div class="em-sug-item" onclick="copySug(this,'${e.id}')" title="Click to copy"><span class="copy-icon">üìã</span>${esc(s)}</div>`;});}
  h+=`</div>`;
  h+=`<button class="btn btn-s btn-sm" onclick="genSug('${e.id}')" style="margin-top:6px" id="sugBtn_${e.id}">Generate Examples ‚ñ∂</button>`;

  h+=`<div class="em-input-area" style="margin-top:12px"><div class="dp-st">Write / Paste Example</div><textarea id="emIn_${e.id}" placeholder='Write or paste an example using "${e.expression}"...' rows="2"></textarea></div>`;
  const isReview=due&&!e.mastered;const isActivation=noEx;
  h+=`<div class="em-actions"><span class="em-note">${isActivation?'üí° First example activates review cycle':isReview?'üí° Saving counts as review #'+(e.reviewCount+1):'Add to your examples'}</span><button class="btn btn-p btn-sm" onclick="saveEx('${e.id}')">${isActivation?'Save & Activate ‚ñ∂':isReview?'Save & Review ‚úì':'Save Example'}</button></div>`;
  h+=`</div>`;
  el.innerHTML=h;
}

function copySug(el,id){
  const text=el.textContent.replace('üìã','').trim();
  const inp=document.getElementById('emIn_'+id);
  if(inp){inp.value=text;inp.focus();}
}
function copySugT(el,id){
  const text=el.textContent.replace('üìã','').trim();
  const inp=document.getElementById('trev_'+id);
  if(inp){inp.value=text;inp.focus();}
}
async function genSugT(id){
  const e=D.expressions.find(x=>x.id===id);if(!e)return;
  const btn=document.getElementById('tsugBtn_'+id);if(btn){btn.disabled=true;btn.textContent='Generating...';}
  const area=document.getElementById('tsug_'+id);
  if(area)area.innerHTML=`<div class="loading"><div class="spinner"></div>Generating...</div>`;
  const prompt=`Generate 5 natural example sentences using the English expression "${e.expression}" (meaning: ${e.meaning}). Each sentence should show a different context or situation. Return ONLY a JSON array of 5 strings.`;
  try{
    const data=await callGem(prompt);const parsed=JSON.parse(data);sugCache[id]=parsed;
    if(area){let h='';parsed.forEach(s=>{h+=`<div class="em-sug-item" onclick="copySugT(this,'${id}')" title="Click to copy"><span class="copy-icon">üìã</span>${esc(s)}</div>`;});area.innerHTML=h;}
  }catch(err){if(area)area.innerHTML=`<div style="font-size:12px;color:var(--red);padding:8px">Error: ${err.message}</div>`;}
  if(btn){btn.disabled=false;btn.textContent='Generate Examples ‚ñ∂';}
}

async function genSug(id){
  const e=D.expressions.find(x=>x.id===id);if(!e)return;
  const btn=document.getElementById('sugBtn_'+id);if(btn){btn.disabled=true;btn.textContent='Generating...';}
  const area=document.getElementById('sugArea_'+id);
  if(area)area.innerHTML=`<div class="loading"><div class="spinner"></div>Generating...</div>`;
  const prompt=`Generate 5 natural example sentences using the English expression "${e.expression}" (meaning: ${e.meaning}). Each sentence should show a different context or situation. Return ONLY a JSON array of 5 strings.`;
  try{
    const data=await callGem(prompt);
    const parsed=JSON.parse(data);
    sugCache[id]=parsed;
    if(area){let h='';parsed.forEach(s=>{h+=`<div class="em-sug-item" onclick="copySug(this,'${id}')" title="Click to copy"><span class="copy-icon">üìã</span>${esc(s)}</div>`;});area.innerHTML=h;}
  }catch(err){if(area)area.innerHTML=`<div style="font-size:12px;color:var(--red);padding:8px">Error: ${err.message}</div>`;}
  if(btn){btn.disabled=false;btn.textContent='Generate Examples ‚ñ∂';}
}

function saveEx(id){
  const e=D.expressions.find(x=>x.id===id);if(!e)return;
  const inp=document.getElementById('emIn_'+id);
  if(!inp||!inp.value.trim()){alert('Please write or paste an example sentence.');return;}
  const txt=inp.value.trim();
  const noEx=isNoEx(e);
  const due=isDue(e)&&!e.mastered;
  if(noEx){
    // First example = activation, start review cycle from today
    if(!e.examples)e.examples=[];
    e.examples.push({date:td(),text:txt});
    e.activated=true;
    e.learnedDate=td();
    e.nextReviewDate=cNext(td(),0);
  } else if(due){
    // Count as review
    e.reviews.push({date:td(),example:txt});
    e.reviewCount++;
    if(e.reviewCount>=5){e.mastered=true;e.nextReviewDate=null;}
    else{e.nextReviewDate=cNext(td(),e.reviewCount);}
  } else {
    if(!e.examples)e.examples=[];
    e.examples.push({date:td(),text:txt});
  }
  save();rAllList();rAllDet();
  if(ct==='today')rToday();
}

// Modal
function oMo(){document.getElementById('addMo').classList.add('show');document.getElementById('mE').focus();}
function cMo(){document.getElementById('addMo').classList.remove('show');document.getElementById('mE').value='';document.getElementById('mM').value='';}
function addE(expr,mean,src){
  const ex=expr||document.getElementById('mE').value.trim();
  const mn=mean||document.getElementById('mM').value.trim();
  if(!ex||!mn)return;
  const e={id:'e_'+Date.now(),expression:ex,meaning:mn,learnedDate:td(),reviewCount:0,nextReviewDate:null,mastered:false,reviews:[],examples:[],source:src||'manual',activated:false};
  D.expressions.push(e);save();cMo();selId=e.id;
  if(ct==='all'){rAllList();rAllDet();}
  return e.id;
}
function delE(id){if(!confirm('Delete this expression?'))return;D.expressions=D.expressions.filter(e=>e.id!==id);if(selId===id)selId=null;save();if(ct==='all'){rAllList();rAllDet();}else rToday();}

// DISCOVER
let dLoad={friends:false,suits:false};
function rDisc(){
  const el=document.getElementById('tDiscover');
  let h=`<div class="dg">`;
  [{k:'friends',e:'üé¨',n:'FRIENDS'},{k:'suits',e:'üíº',n:'SUITS'}].forEach(sh=>{
    h+=`<div class="dc"><div class="dc-h"><div class="dc-t">${sh.e} ${sh.n}</div><button class="btn btn-p btn-sm" onclick="genDL('${sh.k}')" ${dLoad[sh.k]?'disabled':''}>Generate 10 ‚ñ∂</button></div><div class="dc-list" id="dl_${sh.k}">`;
    const list=D.discCache[sh.k]?.list||[];
    if(dLoad[sh.k])h+=`<div class="loading"><div class="spinner"></div>Generating...</div>`;
    else if(!list.length)h+=`<div class="empty" style="padding:20px"><div class="empty-text" style="font-size:12px">Click "Generate 10"</div></div>`;
    else list.forEach((it,i)=>{
      const added=D.expressions.some(e=>e.expression.toLowerCase()===it.expression.toLowerCase());
      h+=`<div class="di${selDi&&selDi.k===sh.k&&selDi.i===i?' sel':''}" onclick="selDi={k:'${sh.k}',i:${i}};shDD('${sh.k}',${i})"><div class="di-l"><div class="di-e">${esc(it.expression)}</div><div class="di-m">${esc(it.meaning_ja)}</div></div>${added?'<span class="added-badge">‚úì Added</span>':`<button class="btn btn-sm btn-s" onclick="event.stopPropagation();addFD('${sh.k}',${i})">+ Add</button>`}</div>`;
    });
    h+=`</div></div>`;
  });
  h+=`</div><div id="ddArea"></div>`;el.innerHTML=h;
}
async function genDL(k){
  dLoad[k]=true;rDisc();const exc=D.excl[k]||[];const sn=k==='friends'?'Friends':'Suits';
  const prompt=`You are an English teacher. List 10 useful and interesting English expressions from the TV show "${sn}". Pick casual, idiomatic, or memorable phrases useful in daily conversation.${exc.length?` Avoid: ${exc.join(', ')}`:''}
Respond ONLY as JSON array: [{"expression":"...","meaning_ja":"..."}]`;
  try{const data=await callGem(prompt);const parsed=JSON.parse(data);if(!D.discCache[k])D.discCache[k]={list:[],details:{}};D.discCache[k].list=parsed;parsed.forEach(p=>{if(!D.excl[k].includes(p.expression))D.excl[k].push(p.expression);});save();}catch(e){alert('API error: '+e.message);}
  dLoad[k]=false;rDisc();
}
async function shDD(k,i){
  const it=D.discCache[k]?.list?.[i];if(!it)return;const area=document.getElementById('ddArea');
  const ck=it.expression;if(D.discCache[k].details[ck]){rnDD(it,D.discCache[k].details[ck],k,i);return;}
  area.innerHTML=`<div class="dd"><div class="loading"><div class="spinner"></div>Loading details...</div></div>`;
  const sn=k==='friends'?'Friends':'Suits';
  const prompt=`Explain "${it.expression}" from TV show "${sn}". Provide: 1) Detailed meaning in Japanese, 2) Usage context in Japanese, 3) 2-3 example sentences in English. Respond ONLY as JSON: {"meaning_detail":"...","usage":"...","examples":["...","..."]}`;
  try{const data=await callGem(prompt);const parsed=JSON.parse(data);D.discCache[k].details[ck]=parsed;save();rnDD(it,parsed,k,i);}catch(e){area.innerHTML=`<div class="dd"><p>Error: ${e.message}</p></div>`;}
}
function rnDD(it,det,k,i){
  const area=document.getElementById('ddArea');const added=D.expressions.some(e=>e.expression.toLowerCase()===it.expression.toLowerCase());
  let h=`<div class="dd"><h4>"${esc(it.expression)}"</h4><div class="dd-m">${esc(det.meaning_detail)}</div><div class="dd-s"><h5>Usage</h5><p style="font-size:13px;color:var(--text2);line-height:1.5">${esc(det.usage)}</p></div><div class="dd-s"><h5>Examples</h5>`;
  (det.examples||[]).forEach(ex=>{h+=`<div class="dd-ex">${esc(ex)}</div>`;});
  h+=`</div>${added?'<span class="added-badge" style="font-size:13px">‚úì Already in your list</span>':`<button class="btn btn-p" onclick="addFD('${k}',${i})">+ Add to My List</button>`}</div>`;
  area.innerHTML=h;
}
function addFD(k,i){const it=D.discCache[k]?.list?.[i];if(!it)return;if(D.expressions.some(e=>e.expression.toLowerCase()===it.expression.toLowerCase()))return;addE(it.expression,it.meaning_ja,k);rDisc();}

async function callGem(prompt){
  const url=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GKEY}`;
  const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{responseMimeType:'application/json'}})});
  if(!res.ok)throw new Error(`API ${res.status}`);const json=await res.json();let text=json.candidates?.[0]?.content?.parts?.[0]?.text;if(!text)throw new Error('Empty response');
  text=text.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();
  text=text.replace(/[\x00-\x1f\x7f]/g,m=>m==='\n'||m==='\r'||m==='\t'?m:'');
  return text;
}

function tTh(){const h=document.documentElement,c=h.dataset.theme,n=c==='dark'?'light':'dark';h.dataset.theme=n;document.getElementById('tb').textContent=n==='dark'?'‚òÄÔ∏è':'üåô';try{localStorage.setItem('evth',n);}catch(e){}}
function lTh(){try{const t=localStorage.getItem('evth');if(t){document.documentElement.dataset.theme=t;document.getElementById('tb').textContent=t==='dark'?'‚òÄÔ∏è':'üåô';}}catch(e){}}

document.getElementById('addMo').addEventListener('click',function(e){if(e.target===this)cMo();});
document.addEventListener('keydown',function(e){if(e.key==='Escape')cMo();});

load();lTh();rNav();rT();
</script>
</body>
</html>
